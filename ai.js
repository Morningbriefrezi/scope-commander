import OpenAI from 'openai';
import { SHOP, CATEGORIES, pickRandom } from './config.js';
import { scrapeGeorgianShops } from './scraper.js';

let _openai;
function ai() {
  if (!_openai) _openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
  return _openai;
}

async function ask(system, prompt, temp = 0.95, maxTokens = 3500) {
  const res = await ai().chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      { role: 'system', content: system },
      { role: 'user', content: prompt }
    ],
    temperature: temp,
    max_tokens: maxTokens
  });
  return res.choices[0].message.content.trim();
}

const BASE_SYSTEM = `рЃерЃћрЃю рЃ«рЃљрЃа "${SHOP.name}" рЃЏрЃљрЃдрЃљрЃќрЃўрЃўрЃА рЃАрЃЮрЃфрЃўрЃљрЃџрЃБрЃарЃў рЃЏрЃћрЃЊрЃўрЃўрЃА рЃЏрЃћрЃюрЃћрЃ»рЃћрЃарЃў рЃЊрЃљ рЃЏрЃљрЃарЃЎрЃћрЃбрЃўрЃюрЃњрЃўрЃА рЃћрЃЦрЃАрЃърЃћрЃарЃбрЃў.
рЃЏрЃљрЃдрЃљрЃќрЃўрЃљ рЃДрЃўрЃЊрЃўрЃА: ${SHOP.niche}.
рЃърЃџрЃљрЃбрЃцрЃЮрЃарЃЏрЃћрЃЉрЃў: ${SHOP.platforms.join(', ')}.
рЃАрЃљрЃЏрЃўрЃќрЃюрЃћ рЃљрЃБрЃЊрЃўрЃбрЃЮрЃарЃўрЃљ: ${SHOP.targetAudience.join(', ')}.

рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃў рЃгрЃћрЃАрЃћрЃЉрЃў:
- рЃгрЃћрЃарЃћ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ. рЃљрЃарЃфрЃћрЃарЃЌрЃў рЃАрЃўрЃбрЃДрЃЋрЃљ рЃАрЃ«рЃЋрЃљ рЃћрЃюрЃљрЃќрЃћ (рЃњрЃљрЃарЃЊрЃљ рЃЉрЃарЃћрЃюрЃЊрЃћрЃЉрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃћрЃЉрЃўрЃАрЃљ рЃЊрЃљ рЃ░рЃћрЃерЃЌрЃћрЃњрЃћрЃЉрЃўрЃАрЃљ).
- рЃљрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃЮ рЃцрЃарЃљрЃюрЃњрЃБрЃџрЃў, рЃћрЃАрЃърЃљрЃюрЃБрЃарЃў, рЃарЃБрЃАрЃБрЃџрЃў рЃљрЃю рЃАрЃ«рЃЋрЃљ рЃћрЃюрЃљ.
- рЃАрЃћрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃАрЃљрЃЌрЃљрЃБрЃарЃћрЃЉрЃў рЃгрЃћрЃарЃћ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ.
- рЃўрЃДрЃљрЃЋрЃў рЃЎрЃарЃћрЃљрЃбрЃўрЃБрЃџрЃў рЃЊрЃљ рЃЮрЃарЃўрЃњрЃўрЃюрЃљрЃџрЃБрЃарЃў.
- рЃДрЃЮрЃЋрЃћрЃџ рЃ»рЃћрЃарЃќрЃћ рЃАрЃ«рЃЋрЃљ рЃЏрЃўрЃЊрЃњрЃЮрЃЏрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ.
- рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃћрЃЏрЃЮрЃ»рЃўрЃћрЃЉрЃў рЃЉрЃБрЃюрЃћрЃЉрЃарЃўрЃЋрЃљрЃЊ.
- рЃбрЃћрЃЦрЃАрЃбрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЏрЃќрЃљрЃЊ рЃЎрЃЮрЃърЃў-рЃцрЃћрЃўрЃАрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА.`;

const STRICT_GEO = `рЃгрЃћрЃарЃћ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ. рЃљрЃарЃфрЃћрЃарЃЌрЃў рЃАрЃўрЃбрЃДрЃЋрЃљ рЃцрЃарЃљрЃюрЃњрЃБрЃџрЃљрЃЊ, рЃўрЃюрЃњрЃџрЃўрЃАрЃБрЃарЃљрЃЊ рЃљрЃю рЃарЃБрЃАрЃБрЃџрЃљрЃЊ (рЃњрЃљрЃарЃЊрЃљ рЃЉрЃарЃћрЃюрЃЊрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃћрЃЉрЃўрЃАрЃљ). рЃАрЃћрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃАрЃљрЃЌрЃљрЃБрЃарЃћрЃЉрЃў, рЃљрЃдрЃгрЃћрЃарЃћрЃЉрЃў, рЃљрЃюрЃљрЃџрЃўрЃќрЃў Рђћ рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ.`;

export async function generatePost(categoryKey) {
  const cat = CATEGORIES[categoryKey];
  if (!cat) return 'рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃўрЃФрЃћрЃЉрЃюрЃљ';

  const angle = pickRandom(cat.angles);
  const seed = Math.random().toString(36).slice(2, 8);

  const SHORT_POST_SYSTEM = `
рЃерЃћрЃю рЃ«рЃљрЃа "${SHOP.name}"-рЃА рЃАрЃЮрЃфрЃўрЃљрЃџрЃБрЃарЃў рЃЏрЃћрЃЊрЃўрЃўрЃА рЃърЃарЃЮрЃцрЃћрЃАрЃўрЃЮрЃюрЃљрЃџрЃў рЃЎрЃЮрЃърЃўрЃарЃљрЃўрЃЌрЃћрЃарЃў.

рЃгрЃћрЃарЃћ рЃАрЃљрЃерЃБрЃљрЃџрЃЮ рЃљрЃю рЃЏрЃЮрЃЎрЃџрЃћ рЃърЃЮрЃАрЃбрЃў.
рЃљрЃарЃљ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃАрЃћрЃЦрЃфрЃўрЃћрЃЉрЃў.
рЃљрЃарЃљ HOOK рЃАрЃљрЃЌрЃљрЃБрЃарЃў.
рЃљрЃарЃљ 15 рЃ░рЃћрЃерЃЌрЃћрЃњрЃў.
рЃљрЃарЃљ "рЃЋрЃўрЃќрЃБрЃљрЃџрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ".
рЃљрЃарЃљ рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃўрЃА рЃЊрЃарЃЮ.
рЃљрЃарЃљ рЃќрЃћрЃЊрЃЏрЃћрЃбрЃў рЃљрЃ«рЃАрЃюрЃљ.

рЃгрЃћрЃарЃћ рЃЉрЃБрЃюрЃћрЃЉрЃарЃўрЃЋрЃљрЃЊ, рЃарЃЮрЃњрЃЮрЃарЃф рЃарЃћрЃљрЃџрЃБрЃарЃў Facebook рЃърЃЮрЃАрЃбрЃў.
2-3 рЃљрЃЉрЃќрЃљрЃфрЃў.
рЃћрЃЏрЃЮрЃфрЃўрЃБрЃарЃў, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃљрЃарЃљ рЃќрЃћрЃЊрЃЏрЃћрЃбрЃљрЃЊ.
рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ рЃћрЃЏрЃЮрЃ»рЃў рЃЉрЃБрЃюрЃћрЃЉрЃарЃўрЃЋрЃљрЃЊ.
рЃЏрЃќрЃљрЃЊ рЃўрЃДрЃЮрЃА рЃърЃўрЃарЃЊрЃљрЃърЃўрЃа рЃЊрЃљрЃАрЃљрЃърЃЮрЃАрЃбрЃљрЃЊ.

рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃБрЃЏ 400 рЃАрЃўрЃЏрЃЉрЃЮрЃџрЃЮ.
рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ.
`;

  const prompt = `
рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃћрЃарЃЌрЃў рЃЏрЃќрЃљ рЃАрЃЮрЃфрЃўрЃљрЃџрЃБрЃарЃў рЃЏрЃћрЃЊрЃўрЃўрЃА рЃърЃЮрЃАрЃбрЃў.

рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ: ${cat.name}
рЃЏрЃўрЃЊрЃњрЃЮрЃЏрЃљ: ${angle}
рЃАрЃљрЃЎрЃЋрЃљрЃюрЃФрЃЮ рЃАрЃўрЃбрЃДрЃЋрЃћрЃЉрЃў: ${cat.keywords.join(', ')}
рЃАрЃўрЃЊрЃў: ${seed}

рЃљрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃЮ рЃАрЃћрЃЦрЃфрЃўрЃћрЃЉрЃў рЃљрЃю рЃАрЃљрЃЌрЃљрЃБрЃарЃћрЃЉрЃў.
рЃљрЃа рЃЕрЃљрЃЏрЃЮрЃЌрЃЋрЃљрЃџрЃЮ рЃърЃБрЃюрЃЦрЃбрЃћрЃЉрЃљрЃЊ.
рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ рЃћрЃарЃЌрЃў рЃЉрЃБрЃюрЃћрЃЉрЃарЃўрЃЋрЃў рЃърЃЮрЃАрЃбрЃў.
`;

  return ask(SHORT_POST_SYSTEM, prompt, 0.9, 600);
}

export async function dailyCampaign(focus = '') {
  const seed = Math.random().toString(36).slice(2, 8);
  const days = ['рЃЎрЃЋрЃўрЃарЃљ', 'рЃЮрЃарЃерЃљрЃЉрЃљрЃЌрЃў', 'рЃАрЃљрЃЏрЃерЃљрЃЉрЃљрЃЌрЃў', 'рЃЮрЃЌрЃ«рЃерЃљрЃЉрЃљрЃЌрЃў', 'рЃ«рЃБрЃЌрЃерЃљрЃЉрЃљрЃЌрЃў', 'рЃърЃљрЃарЃљрЃАрЃЎрЃћрЃЋрЃў', 'рЃерЃљрЃЉрЃљрЃЌрЃў'];
  const dayName = days[new Date().getDay()];

  const prompt = `рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃЊрЃдрЃћрЃЋрЃљрЃюрЃЊрЃћрЃџрЃў рЃАрЃарЃБрЃџрЃў рЃЏрЃљрЃарЃЎрЃћрЃбрЃўрЃюрЃњрЃБрЃџрЃў рЃњрЃћрЃњрЃЏрЃљ "${SHOP.name}"-рЃАрЃЌрЃЋрЃўрЃА.

рЃЊрЃдрЃћрЃА: ${dayName}, ${new Date().toISOString().split('T')[0]}
${focus ? `рЃцрЃЮрЃЎрЃБрЃАрЃў: ${focus}` : ''}
рЃАрЃўрЃЊрЃў: ${seed}

рЃњрЃћрЃњрЃЏрЃљ:

­ЪїЁ рЃЊрЃўрЃџрЃўрЃА рЃърЃЮрЃАрЃбрЃў (9:00-11:00):
- рЃърЃџрЃљрЃбрЃцрЃЮрЃарЃЏрЃљ рЃЊрЃљ рЃцрЃЮрЃарЃЏрЃљрЃбрЃў
- рЃЏрЃќрЃљ рЃбрЃћрЃЦрЃАрЃбрЃў (рЃЎрЃЮрЃърЃў-рЃцрЃћрЃўрЃАрЃбрЃў)
- рЃЋрЃўрЃќрЃБрЃљрЃџрЃўрЃА рЃўрЃЊрЃћрЃљ

­Ъїъ рЃерЃБрЃљрЃЊрЃдрЃўрЃА рЃљрЃЦрЃбрЃўрЃЋрЃЮрЃЉрЃљ (13:00-15:00):
- Stories/Reels рЃўрЃЊрЃћрЃљ
- рЃЏрЃќрЃљ рЃбрЃћрЃЦрЃАрЃбрЃў
- рЃўрЃюрЃбрЃћрЃарЃљрЃЦрЃфрЃўрЃўрЃА рЃбрЃљрЃЦрЃбрЃўрЃЎрЃљ

­ЪїЎ рЃАрЃљрЃдрЃљрЃЏрЃЮрЃА рЃърЃЮрЃАрЃбрЃў (19:00-21:00):
- рЃърЃџрЃљрЃбрЃцрЃЮрЃарЃЏрЃљ рЃЊрЃљ рЃцрЃЮрЃарЃЏрЃљрЃбрЃў
- рЃЏрЃќрЃљ рЃбрЃћрЃЦрЃАрЃбрЃў
- CTA

­ЪЊб рЃЊрЃдрЃўрЃА рЃљрЃЦрЃфрЃўрЃљ:
- рЃерЃћрЃЌрЃљрЃЋрЃљрЃќрЃћрЃЉрЃљ
- рЃБрЃарЃњрЃћрЃюрЃбрЃБрЃџрЃЮрЃЉрЃўрЃА рЃбрЃљрЃЦрЃбрЃўрЃЎрЃљ

­ЪЊі рЃЏрЃћрЃбрЃарЃўрЃЎрЃћрЃЉрЃў

рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ!`;

  return ask(BASE_SYSTEM, prompt);
}

export async function weeklyCampaign(focus = '') {
  const seed = Math.random().toString(36).slice(2, 8);

  const prompt = `рЃерЃћрЃЦрЃЏрЃћрЃюрЃў 7-рЃЊрЃдрЃўрЃљрЃюрЃў рЃЏрЃљрЃарЃЎрЃћрЃбрЃўрЃюрЃњрЃБрЃџрЃў рЃЎрЃљрЃЏрЃърЃљрЃюрЃўрЃљ "${SHOP.name}"-рЃАрЃЌрЃЋрЃўрЃА.

${focus ? `рЃЌрЃћрЃЏрЃљ: ${focus}` : 'рЃерЃћрЃЏрЃЮрЃЌрЃљрЃЋрЃљрЃќрЃћ рЃАрЃљрЃБрЃЎрЃћрЃЌрЃћрЃАрЃЮ рЃЌрЃћрЃЏрЃљ'}
рЃАрЃўрЃЊрЃў: ${seed}

рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃЊрЃдрЃўрЃАрЃЌрЃЋрЃўрЃА (рЃЮрЃарЃерЃљрЃЉрЃљрЃЌрЃў-рЃЎрЃЋрЃўрЃарЃљ):
­Ъј» рЃЊрЃдрЃўрЃА рЃЌрЃћрЃЏрЃљ
­ЪЊ▒ Instagram рЃърЃЮрЃАрЃбрЃў (рЃЏрЃќрЃљ рЃбрЃћрЃЦрЃАрЃбрЃў + рЃ░рЃћрЃерЃЌрЃћрЃњрЃћрЃЉрЃў, рЃЏрЃЮрЃЎрЃџрЃћ рЃбрЃћрЃЦрЃАрЃбрЃў)
­Ъјг TikTok/Reels рЃАрЃЎрЃарЃўрЃърЃбрЃў
­ЪЊў Facebook рЃърЃЮрЃАрЃбрЃў (рЃЏрЃЮрЃЎрЃџрЃћ рЃбрЃћрЃЦрЃАрЃбрЃў)
­ЪЊИ рЃЋрЃўрЃќрЃБрЃљрЃџрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ
РЈ░ рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃћрЃДрЃюрЃћрЃЉрЃўрЃА рЃЊрЃарЃЮ

рЃърЃџрЃБрЃА:
­Ъњ░ рЃЎрЃЋрЃўрЃарЃўрЃА рЃљрЃЦрЃфрЃўрЃљ
­ЪЊД SMS/WhatsApp рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ (1 рЃфрЃљрЃџрЃў)
­ЪцЮ рЃЌрЃљрЃюрЃљрЃЏрЃерЃарЃЮрЃЏрЃџрЃЮрЃЉрЃўрЃА рЃўрЃЊрЃћрЃљ
­ЪЊі KPI-рЃћрЃЉрЃў

рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ!`;

  return ask(BASE_SYSTEM, prompt, 0.9, 4000);
}

export async function generateImage(description) {
  const useNano = process.env.NANOBANANA_API_KEY && description.toLowerCase().includes('nano:');
  const cleanDesc = description.replace(/nano:/i, '').trim();

  if (useNano) {
    const axios = (await import('axios')).default;
    const response = await axios.post('https://api.nanobanana.com/v1/generate', {
      prompt: cleanDesc, style: 'commercial_photo'
    }, {
      headers: { 'Authorization': `Bearer ${process.env.NANOBANANA_API_KEY}` },
      timeout: 60000
    });
    return { url: response.data.url || response.data.image_url, source: 'Nanobanana' };
  }

  const prompt = `Professional product photography for Astromani telescope and lamp store. ${cleanDesc}. Style: modern, clean, dramatic lighting, Instagram-worthy. No text, no watermarks.`;
  const response = await ai().images.generate({
    model: 'dall-e-3', prompt, n: 1, size: '1024x1024', quality: 'standard'
  });
  return { url: response.data[0].url, source: 'DALL-E 3' };
}

export async function findViralProducts() {
  let scrapedProducts = [];
  try {
    scrapedProducts = await scrapeGeorgianShops();
  } catch (err) {
    console.error('Scraping failed:', err.message);
  }

  const scrapedData = scrapedProducts.length > 0
    ? `\n\nрЃарЃћрЃљрЃџрЃБрЃарЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃЏрЃљрЃдрЃљрЃќрЃўрЃћрЃЉрЃўрЃЊрЃљрЃю (рЃљрЃ«рЃџрЃљрЃ«рЃљрЃю рЃАрЃЎрЃљрЃюрЃўрЃарЃћрЃЉрЃБрЃџрЃў):\n${scrapedProducts.map((p, i) => `${i + 1}. [${p.source}] "${p.name}" Рђћ ${p.price} Рђћ ${p.link}`).join('\n')}`
    : '\n\n(рЃАрЃЎрЃљрЃюрЃўрЃарЃћрЃЉрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ Рђћ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃерЃћрЃюрЃў рЃфрЃЮрЃЊрЃюрЃљ рЃЉрЃљрЃќрЃарЃўрЃА рЃерЃћрЃАрЃљрЃ«рЃћрЃЉ)';

  const seed = Math.random().toString(36).slice(2, 8);

  const prompt = `рЃњрЃљрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃћ рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃЉрЃљрЃќрЃљрЃарЃў рЃЊрЃљ рЃерЃћрЃЏрЃЮрЃЌрЃљрЃЋрЃљрЃќрЃћ 8-10 рЃЋрЃўрЃарЃБрЃАрЃБрЃџрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў "${SHOP.name}"-рЃА рЃЎрЃљрЃбрЃљрЃџрЃЮрЃњрЃўрЃАрЃЌрЃЋрЃўрЃА.
${scrapedData}

рЃАрЃўрЃЊрЃў: ${seed}

рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃАрЃЌрЃЋрЃўрЃА:
­ЪЊд рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў (рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ)
­Ъњ░ рЃАрЃљрЃЋрЃљрЃарЃљрЃБрЃЊрЃЮ рЃцрЃљрЃАрЃў рЃџрЃљрЃарЃерЃў
­ЪЊі рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃўрЃА рЃЊрЃЮрЃюрЃћ (­ЪЪб рЃЏрЃљрЃдрЃљрЃџрЃў / ­ЪЪА рЃАрЃљрЃерЃБрЃљрЃџрЃЮ / ­Ъћ┤ рЃЊрЃљрЃЉрЃљрЃџрЃў)
­ЪЈф рЃАрЃљрЃЊ рЃўрЃДрЃўрЃЊрЃћрЃЉрЃљ рЃљрЃ«рЃџрЃљ рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃерЃў
­ЪњА рЃарЃљрЃбрЃЮрЃЏ рЃљрЃарЃўрЃА рЃбрЃарЃћрЃюрЃЊрЃБрЃџрЃў
­Ъј» рЃЏрЃљрЃарЃЎрЃћрЃбрЃўрЃюрЃњрЃўрЃА рЃЎрЃБрЃЌрЃ«рЃћ Рђћ рЃарЃЮрЃњрЃЮрЃа рЃњрЃљрЃЋрЃДрЃўрЃЊрЃЮрЃЌ
­Ъњх рЃАрЃљрЃЋрЃљрЃарЃљрЃБрЃЊрЃЮ рЃЏрЃљрЃарЃЪрЃљ (рЃърЃарЃЮрЃфрЃћрЃюрЃбрЃў)
­ЪћЌ AliExpress-рЃќрЃћ рЃФрЃўрЃћрЃЉрЃўрЃА рЃбрЃћрЃарЃЏрЃўрЃюрЃў

рЃЉрЃЮрЃџрЃЮрЃА:
РГљ рЃбрЃЮрЃъ 3 рЃАрЃљрЃБрЃЎрЃћрЃЌрЃћрЃАрЃЮ рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃџрЃЮрЃЉрЃљ
Рџа№ИЈ рЃарЃўрЃАрЃЎрЃћрЃЉрЃў
­ЪЊѕ рЃбрЃарЃћрЃюрЃЊрЃўрЃА рЃърЃарЃЮрЃњрЃюрЃЮрЃќрЃў рЃЏрЃЮрЃЏрЃЊрЃћрЃЋрЃюрЃЮ рЃЌрЃЋрЃўрЃАрЃЌрЃЋрЃўрЃА

рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ!`;

  return ask(
    `${STRICT_GEO} рЃерЃћрЃю рЃ«рЃљрЃа рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃћ-рЃЎрЃЮрЃЏрЃћрЃарЃфрЃўрЃўрЃА рЃћрЃЦрЃАрЃърЃћрЃарЃбрЃў. рЃўрЃфрЃюрЃЮрЃЉ Mymarket.ge, Extra.ge, Zoommer.ge рЃцрЃљрЃАрЃћрЃЉрЃА рЃЊрЃљ рЃбрЃарЃћрЃюрЃЊрЃћрЃЉрЃА.`,
    prompt, 0.85, 4000
  );
}

export async function georgianCompetitorAnalysis() {
  let scrapedProducts = [];
  try {
    scrapedProducts = await scrapeGeorgianShops();
  } catch (err) {
    console.error('Scraping failed:', err.message);
  }

  const marketData = scrapedProducts.length > 0
    ? `\n\nрЃарЃћрЃљрЃџрЃБрЃарЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў (рЃљрЃ«рЃџрЃљрЃ«рЃљрЃю рЃАрЃЎрЃљрЃюрЃўрЃарЃћрЃЉрЃБрЃџрЃў):\n${scrapedProducts.slice(0, 30).map((p, i) => `${i + 1}. [${p.source}] "${p.name}" Рђћ ${p.price}`).join('\n')}`
    : '';

  const seed = Math.random().toString(36).slice(2, 8);

  const prompt = `рЃњрЃљрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃћ рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃЉрЃљрЃќрЃљрЃарЃў рЃбрЃћрЃџрЃћрЃАрЃЎрЃЮрЃърЃћрЃЉрЃўрЃА, рЃџрЃљрЃЏрЃърЃћрЃЉрЃўрЃАрЃљ рЃЊрЃљ рЃАрЃљрЃЉрЃљрЃЋрЃерЃЋрЃЮ рЃАрЃљрЃЌрЃљрЃЏрЃљрЃерЃЮрЃћрЃЉрЃўрЃА рЃАрЃћрЃњрЃЏрЃћрЃюрЃбрЃерЃў.
${marketData}

рЃАрЃўрЃЊрЃў: ${seed}

­ЪЈф рЃЎрЃЮрЃюрЃЎрЃБрЃарЃћрЃюрЃбрЃћрЃЉрЃў рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃерЃў:
- рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЏрЃљрЃдрЃљрЃќрЃўрЃћрЃЉрЃў рЃЊрЃљ рЃЋрЃћрЃЉрЃАрЃљрЃўрЃбрЃћрЃЉрЃў
- рЃцрЃљрЃАрЃћрЃЉрЃў рЃџрЃљрЃарЃерЃў
- рЃАрЃљрЃЊ рЃарЃћрЃЎрЃџрЃљрЃЏрЃўрЃарЃЊрЃћрЃЉрЃўрЃљрЃю
- рЃарЃљ рЃљрЃЎрЃћрЃЌрЃћрЃЉрЃћрЃю рЃЎрЃљрЃарЃњрЃљрЃЊ/рЃфрЃБрЃЊрЃљрЃЊ

­ЪЊі рЃЉрЃљрЃќрЃарЃўрЃА рЃњрЃљрЃърЃћрЃЉрЃў:
- рЃарЃљ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў рЃљрЃа рЃљрЃарЃўрЃА рЃЉрЃљрЃќрЃљрЃарЃќрЃћ
- рЃарЃљ рЃАрЃћрЃарЃЋрЃўрЃАрЃў рЃљрЃЎрЃџрЃўрЃљ рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃА

­Ъј» "${SHOP.name}"-рЃА рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃџрЃЮрЃЉрЃћрЃЉрЃў:
- 5 рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃюрЃљрЃЉрЃўрЃ»рЃў
- рЃърЃЮрЃќрЃўрЃфрЃўрЃЮрЃюрЃўрЃарЃћрЃЉрЃўрЃА рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃљ
- рЃцрЃљрЃАрЃгрЃљрЃарЃЏрЃЮрЃЦрЃЏрЃюрЃљ (рЃџрЃљрЃарЃерЃў)

РџА 3 рЃАрЃгрЃарЃљрЃцрЃў рЃЏрЃЮрЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ рЃљрЃЏ рЃЎрЃЋрЃўрЃарЃўрЃАрЃЌрЃЋрЃўрЃА

рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ!`;

  return ask(
    `${STRICT_GEO} рЃерЃћрЃю рЃ«рЃљрЃа рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃЉрЃљрЃќрЃарЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃбрЃўрЃЎрЃЮрЃАрЃў. рЃўрЃфрЃюрЃЮрЃЉ Mymarket.ge, Extra.ge, Zoommer.ge, Vendoo.ge.`,
    prompt, 0.7, 4000
  );
}

export async function businessIdeas(focus = '') {
  const seed = Math.random().toString(36).slice(2, 8);

  const prompt = `рЃерЃћрЃЏрЃЮрЃЌрЃљрЃЋрЃљрЃќрЃћ 7 рЃўрЃюрЃЮрЃЋрЃљрЃфрЃўрЃБрЃарЃў рЃЉрЃўрЃќрЃюрЃћрЃА рЃўрЃЊрЃћрЃљ "${SHOP.name}"-рЃАрЃЌрЃЋрЃўрЃА.

${focus ? `рЃцрЃЮрЃЎрЃБрЃАрЃў: ${focus}` : ''}
рЃАрЃўрЃЊрЃў: ${seed}

рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃўрЃЊрЃћрЃўрЃАрЃЌрЃЋрЃўрЃА:
­ЪњА рЃўрЃЊрЃћрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў
­ЪЊЮ рЃљрЃдрЃгрЃћрЃарЃљ (2-3 рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃљ)
­Ъј» рЃарЃљрЃбрЃЮрЃЏ рЃўрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃерЃў
РџА рЃАрЃўрЃарЃЌрЃБрЃџрЃћ (рЃЊрЃљрЃЉрЃљрЃџрЃў/рЃАрЃљрЃерЃБрЃљрЃџрЃЮ/рЃЏрЃљрЃдрЃљрЃџрЃў)
­Ъњ░ рЃЉрЃўрЃБрЃ»рЃћрЃбрЃў (рЃџрЃљрЃарЃерЃў)
­ЪЊѕ рЃЏрЃЮрЃАрЃљрЃџрЃЮрЃЊрЃюрЃћрЃџрЃў рЃерЃћрЃЊрЃћрЃњрЃў
­ЪћД рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃюрЃљрЃЉрЃўрЃ»рЃў (30 рЃгрЃБрЃЌрЃерЃў)

рЃўрЃДрЃљрЃЋрЃў рЃЎрЃарЃћрЃљрЃбрЃўрЃБрЃџрЃў! рЃцрЃўрЃЦрЃарЃћ рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃўрЃЌ.
рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃЦрЃљрЃарЃЌрЃБрЃџрЃљрЃЊ!`;

  return ask(`${STRICT_GEO} ${BASE_SYSTEM}`, prompt, 0.95, 4000);
}
